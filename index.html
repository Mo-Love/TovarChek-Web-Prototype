<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –°–∫–ª–∞–¥ –°–∫–∞–Ω–µ—Ä</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π —Ñ–æ–Ω —è–∫ –Ω–∞ iOS */
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 { margin-top: 0; font-size: 24px; }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        }

        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
        }
        .btn-stop { background-color: #ff3b30; }
        .btn-clear { background-color: #8e8e93; margin-top: 20px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        thead { background-color: #f9f9f9; }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
        }

        th { font-weight: 600; color: #333; }
        
        .code-col { font-family: monospace; font-weight: bold; }
        .desc-col { color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì¶ –°–∫–ª–∞–¥ (AI –¢–µ—Å—Ç)</h1>

    <div id="reader"></div>

    <button id="scanBtn" class="btn" onclick="startScanner()">üì∑ –°–∫–∞–Ω—É–≤–∞—Ç–∏</button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopScanner()" style="display:none;">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>

    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th>
                <th>–¢–æ–≤–∞—Ä (Gemini)</th>
            </tr>
        </thead>
        <tbody id="resultBody">
            </tbody>
    </table>

    <button class="btn btn-clear" onclick="clearHistory()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
</div>

<script>
    // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ---
    // –í—Å—Ç–∞–≤ —Å—é–¥–∏ —Å–≤—ñ–π –∫–ª—é—á. –£–í–ê–ì–ê: –ù–∞ GitHub Pages —Ü–µ–π –∫–ª—é—á –±—É–¥–µ –≤–∏–¥–Ω–æ –≤—Å—ñ–º.
    // –î–ª—è —Ç–µ—Å—Ç—É —Ü–µ –æ–∫, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É —Ç—Ä–µ–±–∞ –±–µ–∫–µ–Ω–¥.
    const GEMINI_API_KEY = AIzaSyB38IyHU_8SWYc9u2KQPGuC5I_YvOGIeOI; 
    
    let html5QrcodeScanner;
    const resultBody = document.getElementById('resultBody');
    let isScanning = false;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    window.onload = loadHistory;

    async function startScanner() {
        if (isScanning) return;
        
        document.getElementById('reader').style.display = 'block';
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        html5QrcodeScanner = new Html5Qrcode("reader");
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        try {
            await html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            );
            isScanning = true;
        } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏", err);
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É");
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner && isScanning) {
            html5QrcodeScanner.stop().then(() => {
                document.getElementById('reader').style.display = 'none';
                document.getElementById('scanBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'none';
                isScanning = false;
            });
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        // –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫–∞–Ω–µ—Ä –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è (—â–æ–± –Ω–µ —Å–∫–∞–Ω—É–≤–∞–≤ 100 —Ä–∞–∑—ñ–≤ –æ–¥–Ω—É –ø–∞—á–∫—É)
        stopScanner();
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // 1. –î–æ–¥–∞—î–º–æ —Ä—è–¥–æ–∫ —É —Ç–∞–±–ª–∏—Ü—é –∑ "Loading..."
        const rowId = Date.now(); // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Ä—è–¥–∫–∞
        addTableRow(time, decodedText, "üîç –®—É–∫–∞—é...", rowId);
        
        // 2. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ LocalStorage (–ø–æ–∫–∏ –±–µ–∑ –æ–ø–∏—Å—É)
        saveToLocalStorage(time, decodedText, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");

        // 3. –ó–∞–ø–∏—Ç—É—î–º–æ Gemini
        fetchProductDescription(decodedText, rowId);
    }

    async function fetchProductDescription(barcode, rowId) {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === '–¢–£–¢_–¢–í–Ü–ô_–ö–õ–Æ–ß_GEMINI') {
            updateRowDescription(rowId, "‚ö†Ô∏è –ù–µ–º–∞—î API –∫–ª—é—á–∞");
            return;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const prompt = {
            contents: [{
                parts: [{
                    text: `–Ø–∫–∏–π —Ç–æ–≤–∞—Ä –º–∞—î —à—Ç—Ä–∏—Ö-–∫–æ–¥ ${barcode}? –ù–∞–ø–∏—à–∏ —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–æ—Ç–∫—É –Ω–∞–∑–≤—É —Ç–æ–≤–∞—Ä—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à —Ç–æ—á–Ω–æ, –ø—Ä–∏–ø—É—Å—Ç–∏ –±–∞–∑—É—é—á–∏—Å—å –Ω–∞ –∫–æ–¥—ñ –∞–±–æ –Ω–∞–ø–∏—à–∏ "–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–æ–≤–∞—Ä". –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è, —Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç.`
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(prompt)
            });

            const data = await response.json();
            const description = data.candidates[0].content.parts[0].text.trim();
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–±–ª–∏—Ü—é
            updateRowDescription(rowId, description);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ LocalStorage
            updateLocalStorageDescription(barcode, description);

        } catch (error) {
            console.error("Gemini Error:", error);
            updateRowDescription(rowId, "‚ùå –ü–æ–º–∏–ª–∫–∞ AI");
        }
    }

    function addTableRow(time, code, desc, id) {
        const row = document.createElement('tr');
        row.dataset.id = id;
        row.innerHTML = `
            <td>${time}</td>
            <td class="code-col">${code}</td>
            <td class="desc-col" id="desc-${id}">${desc}</td>
        `;
        // –î–æ–¥–∞—î–º–æ –∑–≤–µ—Ä—Ö—É
        resultBody.insertBefore(row, resultBody.firstChild);
    }

    function updateRowDescription(rowId, newText) {
        const cell = document.getElementById(`desc-${rowId}`);
        if (cell) {
            cell.textContent = newText;
        }
    }

    function saveToLocalStorage(time, code, desc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        history.unshift({ time, code, desc, id: Date.now() });
        if (history.length > 50) history.pop(); // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ 50
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function updateLocalStorageDescription(code, newDesc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –ø–µ—Ä—à–∏–π –∑–∞–ø–∏—Å –∑ —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —ñ –æ–Ω–æ–≤–ª—é—î–º–æ
        for (let item of history) {
            if (item.code === code) {
                item.desc = newDesc;
                break; 
            }
        }
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        resultBody.innerHTML = '';
        history.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.time}</td>
                <td class="code-col">${item.code}</td>
                <td class="desc-col">${item.desc}</td>
            `;
            resultBody.appendChild(row);
        });
    }

    function clearHistory() {
        localStorage.removeItem('scanHistory');
        resultBody.innerHTML = '';
    }
</script>

</body>
</html>
