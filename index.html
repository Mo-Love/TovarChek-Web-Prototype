<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –°–∫–ª–∞–¥ –°–∫–∞–Ω–µ—Ä (v2)</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 { margin-top: 0; font-size: 24px; }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            display: none; 
            background: black;
        }

        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }
        .btn:active { opacity: 0.8; }
        .btn-stop { background-color: #ff3b30; }
        .btn-clear { background-color: #8e8e93; margin-top: 20px; font-size: 16px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        thead { background-color: #f9f9f9; }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
        }

        th { font-weight: 600; color: #333; }
        
        .code-col { font-family: monospace; font-weight: bold; }
        .desc-col { color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì¶ –°–∫–ª–∞–¥ + Gemini</h1>

    <div id="reader"></div>

    <button id="scanBtn" class="btn" onclick="startScanner()">üì∑ –°–∫–∞–Ω—É–≤–∞—Ç–∏</button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopScanner()" style="display:none;">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>

    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th>
                <th>–¢–æ–≤–∞—Ä (AI)</th>
            </tr>
        </thead>
        <tbody id="resultBody">
            </tbody>
    </table>

    <button class="btn btn-clear" onclick="clearHistory()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
</div>

<script>
    // --- –í–ê–® –ö–õ–Æ–ß (–í—Å—Ç–∞–≤–ª–µ–Ω–∏–π —ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–π) ---
    const GEMINI_API_KEY = 'AIzaSyB38IyHU_8SWYc9u2KQPGuC5I_YvOGIeOI'; 
    
    let html5QrcodeScanner;
    const resultBody = document.getElementById('resultBody');
    let isScanning = false;

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
    window.onload = loadHistory;

    async function startScanner() {
        if (isScanning) return;
        
        // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å
        if (typeof Html5Qrcode === 'undefined') {
            alert("–ü–æ–º–∏–ª–∫–∞: –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∞—Å—å. –ü–µ—Ä–µ–≤—ñ—Ä —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è.");
            return;
        }

        // –ó–º—ñ–Ω—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('reader').style.display = 'block';
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        try {
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∫–∞–Ω–µ—Ä–∞
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏ (environment = –∑–∞–¥–Ω—è –∫–∞–º–µ—Ä–∞)
            await html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            );
            
            isScanning = true;

        } catch (err) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:", err);
            // –í–ò–í–û–î–ò–ú–û –ü–û–ú–ò–õ–ö–£ –ö–û–†–ò–°–¢–£–í–ê–ß–£
            alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É! \n–ü–æ–º–∏–ª–∫–∞: " + err);
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            stopScannerUI();
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner && isScanning) {
            html5QrcodeScanner.stop().then(() => {
                stopScannerUI();
            }).catch(err => {
                console.error("Failed to stop", err);
                stopScannerUI();
            });
        } else {
            stopScannerUI();
        }
    }

    function stopScannerUI() {
        document.getElementById('reader').style.display = 'none';
        document.getElementById('scanBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        isScanning = false;
    }

    function onScanSuccess(decodedText, decodedResult) {
        // –ó—É–ø–∏–Ω—è—î–º–æ –∫–∞–º–µ—Ä—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—Ö—É
        stopScanner();
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // –ì–µ–Ω–µ—Ä—É—î–º–æ ID –¥–ª—è —Ä—è–¥–∫–∞
        const rowId = Date.now(); 
        
        // –î–æ–¥–∞—î–º–æ –≤ —Ç–∞–±–ª–∏—Ü—é
        addTableRow(time, decodedText, "üîç –®—É–∫–∞—é...", rowId);
        
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ (—Ç–∏–º—á–∞—Å–æ–≤–æ –±–µ–∑ –æ–ø–∏—Å—É)
        saveToLocalStorage(time, decodedText, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");

        // –ü–∏—Ç–∞—î–º–æ AI
        fetchProductDescription(decodedText, rowId);
    }

    async function fetchProductDescription(barcode, rowId) {
        if (!GEMINI_API_KEY) {
            updateRowDescription(rowId, "‚ö†Ô∏è –ù–µ–º–∞—î API –∫–ª—é—á–∞");
            return;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const prompt = {
            contents: [{
                parts: [{
                    text: `–Ø–∫–∏–π —Ç–æ–≤–∞—Ä –º–∞—î —à—Ç—Ä–∏—Ö-–∫–æ–¥ ${barcode}? –ù–∞–ø–∏—à–∏ —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–æ—Ç–∫—É –Ω–∞–∑–≤—É —Ç–æ–≤–∞—Ä—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –Ø–∫—â–æ —Ü–µ –≤—ñ–¥–æ–º–∏–π –±—Ä–µ–Ω–¥, –≤–∫–∞–∂–∏ –π–æ–≥–æ. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à —Ç–æ—á–Ω–æ, –Ω–∞–ø–∏—à–∏ "–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–æ–≤–∞—Ä". –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π Markdown, —Ç—ñ–ª—å–∫–∏ —á–∏—Å—Ç–∏–π —Ç–µ–∫—Å—Ç.`
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(prompt)
            });

            const data = await response.json();
            
            let description = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
            if (data.candidates && data.candidates[0].content) {
                description = data.candidates[0].content.parts[0].text.trim();
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ UI —ñ –ü–∞–º'—è—Ç—å
            updateRowDescription(rowId, description);
            updateLocalStorageDescription(barcode, description);

        } catch (error) {
            console.error("Gemini Error:", error);
            updateRowDescription(rowId, "‚ùå –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
        }
    }

    // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ---

    function addTableRow(time, code, desc, id) {
        const row = document.createElement('tr');
        row.dataset.id = id;
        row.innerHTML = `
            <td>${time}</td>
            <td class="code-col">${code}</td>
            <td class="desc-col" id="desc-${id}">${desc}</td>
        `;
        resultBody.insertBefore(row, resultBody.firstChild);
    }

    function updateRowDescription(rowId, newText) {
        const cell = document.getElementById(`desc-${rowId}`);
        if (cell) cell.textContent = newText;
    }

    function saveToLocalStorage(time, code, desc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        history.unshift({ time, code, desc, id: Date.now() });
        if (history.length > 50) history.pop(); 
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function updateLocalStorageDescription(code, newDesc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        for (let item of history) {
            if (item.code === code) {
                item.desc = newDesc;
                break; 
            }
        }
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        resultBody.innerHTML = '';
        history.forEach(item => {
            // –î–ª—è —Å—Ç–∞—Ä–∏—Ö –∑–∞–ø–∏—Å—ñ–≤, –¥–µ –Ω–µ–º–∞ ID, –≥–µ–Ω–µ—Ä—É—î–º–æ —Ñ–µ–π–∫–æ–≤–∏–π
            const id = item.id || Math.random().toString(36).substr(2, 9);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.time}</td>
                <td class="code-col">${item.code}</td>
                <td class="desc-col" id="desc-${id}">${item.desc || ''}</td>
            `;
            resultBody.appendChild(row);
        });
    }

    function clearHistory() {
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é?")) {
            localStorage.removeItem('scanHistory');
            resultBody.innerHTML = '';
        }
    }
</script>

</body>
</html>
