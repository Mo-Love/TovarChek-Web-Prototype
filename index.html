<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Smart Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 { margin-top: 0; font-size: 24px; }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            display: none; 
            background: black;
            min-height: 250px;
        }

        .zoom-container {
            width: 100%;
            margin-bottom: 20px;
            display: none; 
        }
        
        input[type=range] {
            width: 80%;
            height: 25px;
        }

        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }
        .btn:active { opacity: 0.8; }
        .btn-stop { background-color: #ff3b30; }
        .btn-clear { background-color: #8e8e93; margin-top: 20px; font-size: 16px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        thead { background-color: #f9f9f9; }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
        }

        th { font-weight: 600; color: #333; }
        
        .code-col { font-family: monospace; font-weight: bold; }
        .desc-col { color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì¶ –†–æ–∑—É–º–Ω–∏–π –°–∫–ª–∞–¥</h1>

    <div id="reader"></div>

    <div id="zoomContainer" class="zoom-container">
        <label for="zoomSlider">üîç –ó—É–º (–Ω–∞–ª–∞—à—Ç—É–π —á—ñ—Ç–∫—ñ—Å—Ç—å):</label><br>
        <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
    </div>

    <button id="scanBtn" class="btn" onclick="startScanner()">üì∑ –°–∫–∞–Ω—É–≤–∞—Ç–∏</button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopScanner()" style="display:none;">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>

    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th>
                <th>–ù–∞–∑–≤–∞ —Ç–æ–≤–∞—Ä—É</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>

    <button class="btn btn-clear" onclick="clearHistory()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
</div>

<script>
    const GEMINI_API_KEY = 'AIzaSyB38IyHU_8SWYc9u2KQPGuC5I_YvOGIeOI'; 
    
    let html5QrcodeScanner;
    const resultBody = document.getElementById('resultBody');
    let isScanning = false;

    window.onload = loadHistory;

    async function startScanner() {
        if (isScanning) return;
        
        document.getElementById('reader').style.display = 'block';
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        try {
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 }, 
                aspectRatio: 1.0
            };
            
            await html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            );
            
            isScanning = true;
            checkZoomCapabilities();

        } catch (err) {
            console.error("Camera Error:", err);
            alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: " + err);
            stopScannerUI();
        }
    }

    // –ó—É–ø–∏–Ω–∫–∞ —ñ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    function stopScanner() {
        if (html5QrcodeScanner && isScanning) {
            html5QrcodeScanner.stop().then(stopScannerUI).catch(stopScannerUI);
        } else {
            stopScannerUI();
        }
    }

    function stopScannerUI() {
        document.getElementById('reader').style.display = 'none';
        document.getElementById('scanBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('zoomContainer').style.display = 'none';
        isScanning = false;
    }

    // –ó—É–º
    function checkZoomCapabilities() {
        try {
             const videoElement = document.querySelector("#reader video");
             if (videoElement && videoElement.srcObject) {
                const track = videoElement.srcObject.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                if (capabilities.zoom) {
                    const slider = document.getElementById('zoomSlider');
                    document.getElementById('zoomContainer').style.display = 'block';
                    slider.min = capabilities.zoom.min;
                    slider.max = capabilities.zoom.max;
                    slider.step = capabilities.zoom.step;
                    slider.value = track.getSettings().zoom || 1;
                    slider.oninput = function() {
                        track.applyConstraints({ advanced: [ { zoom: parseFloat(this.value) } ] });
                    }
                }
             }
        } catch (e) { console.log(e); }
    }

    // --- –ì–û–õ–û–í–ù–ê –õ–û–ì–Ü–ö–ê –ü–û–®–£–ö–£ ---
    function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const rowId = Date.now(); 
        
        addTableRow(time, decodedText, "üîç –ü–æ—à—É–∫ –≤ –±–∞–∑–∞—Ö...", rowId);
        saveToLocalStorage(time, decodedText, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
        
        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –ª–∞–Ω—Ü—é–∂–æ–∫ –ø–æ—à—É–∫—É
        identifyProduct(decodedText, rowId);
    }

    async function identifyProduct(barcode, rowId) {
        // –ö–†–û–ö 1: –®—É–∫–∞—î–º–æ –≤ OpenFoodFacts (–ë–∞–∑–∞ —Ä–µ–∞–ª—å–Ω–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤)
        try {
            const dbResponse = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
            const dbData = await dbResponse.json();

            if (dbData.status === 1) {
                // –£–†–ê! –¢–æ–≤–∞—Ä –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ
                let productName = dbData.product.product_name_uk || dbData.product.product_name || dbData.product.generic_name;
                let brand = dbData.product.brands || "";
                
                // –§–æ—Ä–º—É—î–º–æ –≥–∞—Ä–Ω—É –Ω–∞–∑–≤—É
                let fullName = brand ? `${brand} ${productName}` : productName;
                if (!fullName) fullName = "–¢–æ–≤–∞—Ä –∑–Ω–∞–π–¥–µ–Ω–æ (–±–µ–∑ –Ω–∞–∑–≤–∏)";

                updateRowDescription(rowId, "‚úÖ " + fullName);
                updateLocalStorageDescription(barcode, fullName);
                return; // –ó—É–ø–∏–Ω—è—î–º–æ—Å—å, Gemini –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω
            }
        } catch (error) {
            console.log("–ü–æ–º–∏–ª–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ AI...");
        }

        // –ö–†–û–ö 2: –Ø–∫—â–æ –±–∞–∑–∞ –Ω–µ –∑–Ω–∞—î, –ø–∏—Ç–∞—î–º–æ Gemini (—è–∫ –æ—Å—Ç–∞–Ω–Ω—è –Ω–∞–¥—ñ—è)
        askGemini(barcode, rowId);
    }

    async function askGemini(barcode, rowId) {
        if (!GEMINI_API_KEY) {
            updateRowDescription(rowId, "‚ö†Ô∏è –ù–µ–º–∞—î API –∫–ª—é—á–∞");
            return;
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å
        updateRowDescription(rowId, "ü§ñ –ü–∏—Ç–∞—é –®–Ü...");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const prompt = {
            contents: [{
                parts: [{
                    text: `–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π —à—Ç—Ä–∏—Ö-–∫–æ–¥ ${barcode}. 
                    1. –í–∏–∑–Ω–∞—á –∫—Ä–∞—ó–Ω—É –≤–∏—Ä–æ–±–Ω–∏–∫–∞ –∑–∞ –∫–æ–¥–æ–º (–ø–µ—Ä—à—ñ 3 —Ü–∏—Ñ—Ä–∏).
                    2. –Ø–∫—â–æ —Ü–µ –≤—ñ–¥–æ–º–∏–π –≥–ª–æ–±–∞–ª—å–Ω–∏–π –∫–æ–¥, –Ω–∞–∑–≤–∏ —Ç–æ–≤–∞—Ä.
                    3. –Ø–∫—â–æ —Ç–æ—á–Ω–∏–π —Ç–æ–≤–∞—Ä –Ω–µ–≤—ñ–¥–æ–º–∏–π, –Ω–∞–ø–∏—à–∏ –¢–Ü–õ–¨–ö–ò –∫—Ä–∞—ó–Ω—É —ñ –π–º–æ–≤—ñ—Ä–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é.
                    –ü—Ä–∏–∫–ª–∞–¥ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: "–£–∫—Ä–∞—ó–Ω–∞, –º–æ–∂–ª–∏–≤–æ –º–æ–ª–æ—á–Ω—ñ –ø—Ä–æ–¥—É–∫—Ç–∏" –∞–±–æ "Coca-Cola 0.5L".`
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(prompt)
            });

            const data = await response.json();
            let description = "–ù–µ–≤—ñ–¥–æ–º–∏–π –∫–æ–¥";
            
            if (data.candidates && data.candidates[0].content) {
                description = "ü§ñ " + data.candidates[0].content.parts[0].text.trim();
            }
            
            updateRowDescription(rowId, description);
            updateLocalStorageDescription(barcode, description);

        } catch (error) {
            console.error(error);
            updateRowDescription(rowId, "‚ùå –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
        }
    }

    // --- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ---
    function addTableRow(time, code, desc, id) {
        const row = document.createElement('tr');
        row.dataset.id = id;
        row.innerHTML = `
            <td>${time}</td>
            <td class="code-col">${code}</td>
            <td class="desc-col" id="desc-${id}">${desc}</td>
        `;
        resultBody.insertBefore(row, resultBody.firstChild);
    }

    function updateRowDescription(rowId, newText) {
        const cell = document.getElementById(`desc-${rowId}`);
        if (cell) cell.textContent = newText;
    }

    function saveToLocalStorage(time, code, desc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        history.unshift({ time, code, desc, id: Date.now() });
        if (history.length > 50) history.pop(); 
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function updateLocalStorageDescription(code, newDesc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        for (let item of history) {
            if (item.code === code) {
                item.desc = newDesc;
                break; 
            }
        }
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        resultBody.innerHTML = '';
        history.forEach(item => {
            const id = item.id || Math.random().toString(36).substr(2, 9);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.time}</td>
                <td class="code-col">${item.code}</td>
                <td class="desc-col" id="desc-${id}">${item.desc || ''}</td>
            `;
            resultBody.appendChild(row);
        });
    }

    function clearHistory() {
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é?")) {
            localStorage.removeItem('scanHistory');
            resultBody.innerHTML = '';
        }
    }
</script>

</body>
</html>
