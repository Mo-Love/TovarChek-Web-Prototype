<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –°–∫–ª–∞–¥: Zoom –≤–µ—Ä—Å—ñ—è</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f2f2f7;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        h1 { margin-top: 0; font-size: 24px; }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            display: none; 
            background: black;
            min-height: 250px;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–æ–≤–∑—É–Ω–∫–∞ –∑—É–º—É */
        .zoom-container {
            width: 100%;
            margin-bottom: 20px;
            display: none; /* –ü–æ–∫–∞–∂–µ–º–æ –∫–æ–ª–∏ –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è */
        }
        
        input[type=range] {
            width: 80%;
            height: 25px;
        }

        .btn {
            background-color: #007aff;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            width: 100%;
            max-width: 300px;
        }
        .btn:active { opacity: 0.8; }
        .btn-stop { background-color: #ff3b30; }
        .btn-clear { background-color: #8e8e93; margin-top: 20px; font-size: 16px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        thead { background-color: #f9f9f9; }
        
        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e5e5ea;
        }

        th { font-weight: 600; color: #333; }
        
        .code-col { font-family: monospace; font-weight: bold; }
        .desc-col { color: #555; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì¶ –°–∫–ª–∞–¥ + Gemini</h1>

    <div id="reader"></div>

    <div id="zoomContainer" class="zoom-container">
        <label for="zoomSlider">üîç –ó—É–º (–≤—ñ–¥—ñ–π–¥–∏ —ñ –Ω–∞–±–ª–∏–∑—å):</label><br>
        <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1">
    </div>

    <button id="scanBtn" class="btn" onclick="startScanner()">üì∑ –°–∫–∞–Ω—É–≤–∞—Ç–∏</button>
    <button id="stopBtn" class="btn btn-stop" onclick="stopScanner()" style="display:none;">‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏</button>

    <table>
        <thead>
            <tr>
                <th>–ß–∞—Å</th>
                <th>–®—Ç—Ä–∏—Ö-–∫–æ–¥</th>
                <th>–¢–æ–≤–∞—Ä (AI)</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>

    <button class="btn btn-clear" onclick="clearHistory()">üóë –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</button>
</div>

<script>
    const GEMINI_API_KEY = 'AIzaSyB38IyHU_8SWYc9u2KQPGuC5I_YvOGIeOI'; 
    
    let html5QrcodeScanner;
    const resultBody = document.getElementById('resultBody');
    let isScanning = false;

    window.onload = loadHistory;

    async function startScanner() {
        if (isScanning) return;
        
        document.getElementById('reader').style.display = 'block';
        document.getElementById('scanBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';

        try {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∑ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–æ–º —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è, –∞ –Ω–µ –≤—ñ–¥–µ–æ
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 150 }, 
                aspectRatio: 1.0
            };
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞–º–µ—Ä—É
            await html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            );
            
            isScanning = true;
            
            // --- –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ó–£–ú–£ (–ú–∞–≥—ñ—è —Ç—É—Ç) ---
            checkZoomCapabilities();

        } catch (err) {
            console.error("Camera Error:", err);
            alert("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏: " + err);
            stopScannerUI();
        }
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –∑—É–º—É
    function checkZoomCapabilities() {
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomContainer = document.getElementById('zoomContainer');

        // –û—Ç—Ä–∏–º—É—î–º–æ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞–ø—É—â–µ–Ω–æ—ó –∫–∞–º–µ—Ä–∏
        const track = html5QrcodeScanner.getRunningTrackCameraCapabilities(); // –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –∑–∞–≤–∂–¥–∏ –ø—Ä–∞—Ü—é—î –≤ —É—Å—ñ—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö, –∞–ª–µ —Å–ø—Ä–æ–±—É—î–º–æ
        
        // –ë—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–∏–π —Å–ø–æ—Å—ñ–± —á–µ—Ä–µ–∑ –≤—ñ–¥–µ–æ —Ç—Ä–µ–∫
        try {
             // –¶–µ —Ö–∞–∫, —â–æ–± –¥–æ–±—Ä–∞—Ç–∏—Å—è –¥–æ –≤—ñ–¥–µ–æ-—Ç—Ä–µ–∫—É
             const videoElement = document.querySelector("#reader video");
             if (videoElement && videoElement.srcObject) {
                const track = videoElement.srcObject.getVideoTracks()[0];
                const capabilities = track.getCapabilities();

                if (capabilities.zoom) {
                    zoomContainer.style.display = 'block';
                    zoomSlider.min = capabilities.zoom.min;
                    zoomSlider.max = capabilities.zoom.max;
                    zoomSlider.step = capabilities.zoom.step;
                    zoomSlider.value = track.getSettings().zoom || 1;

                    zoomSlider.oninput = function() {
                        track.applyConstraints({
                            advanced: [ { zoom: parseFloat(this.value) } ]
                        });
                    }
                } else {
                    console.log("–ó—É–º –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Ü–∏–º –ø—Ä–∏—Å—Ç—Ä–æ—î–º");
                }
             }
        } catch (e) {
            console.log("–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∑—É–º:", e);
        }
    }

    function stopScanner() {
        if (html5QrcodeScanner && isScanning) {
            html5QrcodeScanner.stop().then(() => {
                stopScannerUI();
            }).catch(err => {
                stopScannerUI();
            });
        } else {
            stopScannerUI();
        }
    }

    function stopScannerUI() {
        document.getElementById('reader').style.display = 'none';
        document.getElementById('scanBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        document.getElementById('zoomContainer').style.display = 'none';
        isScanning = false;
    }

    function onScanSuccess(decodedText, decodedResult) {
        stopScanner();
        
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const rowId = Date.now(); 
        
        addTableRow(time, decodedText, "üîç –®—É–∫–∞—é...", rowId);
        saveToLocalStorage(time, decodedText, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
        fetchProductDescription(decodedText, rowId);
    }

    async function fetchProductDescription(barcode, rowId) {
        if (!GEMINI_API_KEY) {
            updateRowDescription(rowId, "‚ö†Ô∏è –ù–µ–º–∞—î API –∫–ª—é—á–∞");
            return;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const prompt = {
            contents: [{
                parts: [{
                    text: `–Ø–∫–∏–π —Ç–æ–≤–∞—Ä –º–∞—î —à—Ç—Ä–∏—Ö-–∫–æ–¥ ${barcode}? –ù–∞–ø–∏—à–∏ —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–æ—Ç–∫—É –Ω–∞–∑–≤—É —Ç–æ–≤–∞—Ä—É —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à, –Ω–∞–ø–∏—à–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é.`
                }]
            }]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(prompt)
            });

            const data = await response.json();
            
            let description = "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
            if (data.candidates && data.candidates[0].content) {
                description = data.candidates[0].content.parts[0].text.trim();
            }
            
            updateRowDescription(rowId, description);
            updateLocalStorageDescription(barcode, description);

        } catch (error) {
            console.error("Gemini Error:", error);
            updateRowDescription(rowId, "‚ùå –ü–æ–º–∏–ª–∫–∞ AI");
        }
    }

    function addTableRow(time, code, desc, id) {
        const row = document.createElement('tr');
        row.dataset.id = id;
        row.innerHTML = `
            <td>${time}</td>
            <td class="code-col">${code}</td>
            <td class="desc-col" id="desc-${id}">${desc}</td>
        `;
        resultBody.insertBefore(row, resultBody.firstChild);
    }

    function updateRowDescription(rowId, newText) {
        const cell = document.getElementById(`desc-${rowId}`);
        if (cell) cell.textContent = newText;
    }

    function saveToLocalStorage(time, code, desc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        history.unshift({ time, code, desc, id: Date.now() });
        if (history.length > 50) history.pop(); 
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function updateLocalStorageDescription(code, newDesc) {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        for (let item of history) {
            if (item.code === code) {
                item.desc = newDesc;
                break; 
            }
        }
        localStorage.setItem('scanHistory', JSON.stringify(history));
    }

    function loadHistory() {
        let history = JSON.parse(localStorage.getItem('scanHistory')) || [];
        resultBody.innerHTML = '';
        history.forEach(item => {
            const id = item.id || Math.random().toString(36).substr(2, 9);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.time}</td>
                <td class="code-col">${item.code}</td>
                <td class="desc-col" id="desc-${id}">${item.desc || ''}</td>
            `;
            resultBody.appendChild(row);
        });
    }

    function clearHistory() {
        if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—é —ñ—Å—Ç–æ—Ä—ñ—é?")) {
            localStorage.removeItem('scanHistory');
            resultBody.innerHTML = '';
        }
    }
</script>

</body>
</html>
